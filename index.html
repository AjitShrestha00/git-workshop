<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helper Finder - Complete Application</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 70vh; width: 100%; }
    #info { padding: 10px; text-align: center; background: #f8f9fa; }
    #search-bar {
      max-width: 800px;
      margin: 10px auto;
      display: flex;
      gap: 10px;
      padding: 0 10px;
    }
    #search-bar input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #search-bar button {
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #helper-list {
      padding: 10px;
      max-width: 800px;
      margin: 0 auto;
    }
    .helper-card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .helper-card h4 {
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="info">
    <h2>Helper Finder - Complete Application</h2>
    <p>Search for an area or helper, view available services, and request assistance.</p>
  </div>
  <div id="search-bar">
    <input type="text" id="search-input" placeholder="Enter an area (e.g., Kathmandu)" />
    <button onclick="searchArea()">Search</button>
  </div>
  <div id="map"></div>
  <div id="helper-list">
    <h3>Available Helpers</h3>
    <div id="helper-cards"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Map bounds: Kathmandu, Lalitpur, and Bhaktapur
    const mapBounds = [
      [27.5843, 85.2503], // Southwest corner
      [27.7867, 85.4457]  // Northeast corner
    ];

    // Initialize the map
    const map = L.map('map', {
      maxBounds: mapBounds,
      maxBoundsViscosity: 1.0
    }).setView([27.7172, 85.3240], 12);

    // OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Demo helper data
    const helpers = [
      { id: 1, name: "Helper 1", lat: 27.7182, lng: 85.3250, status: "Available", profession: "Electrician" },
      { id: 2, name: "Helper 2", lat: 27.7200, lng: 85.3220, status: "Available", profession: "Plumber" },
      { id: 3, name: "Helper 3", lat: 27.7140, lng: 85.3270, status: "Available", profession: "Carpenter" },
    ];

    // Array to hold markers
    let markers = [];
    function addMarkers(filteredHelpers) {
      markers.forEach(marker => marker.remove()); // Clear existing markers
      markers = [];
      filteredHelpers.forEach(helper => {
        const marker = L.marker([helper.lat, helper.lng]).addTo(map);
        marker.bindPopup(`
          <h4>${helper.name}</h4>
          <p>Profession: ${helper.profession}</p>
          <p>Status: <strong>${helper.status}</strong></p>
          <button onclick="requestService(${helper.id})">Request Service</button>
        `);
        markers.push(marker);
      });
    }

    // Show helper cards in the list
    function updateHelperList(filteredHelpers) {
      const helperCardsContainer = document.getElementById('helper-cards');
      helperCardsContainer.innerHTML = ''; // Clear existing cards
      filteredHelpers.forEach(helper => {
        const card = document.createElement('div');
        card.className = 'helper-card';
        card.innerHTML = `
          <h4>${helper.name}</h4>
          <p>Profession: ${helper.profession}</p>
          <p>Status: <strong>${helper.status}</strong></p>
          <button onclick="requestService(${helper.id})">Request Service</button>
        `;
        helperCardsContainer.appendChild(card);
      });
    }

    // Function to request a service
    function requestService(helperId) {
      const helper = helpers.find(h => h.id === helperId);
      if (helper) {
        if (helper.status === "Available") {
          helper.status = "Requested";
          alert(`You have requested service from ${helper.name}.`);
        } else {
          alert(`${helper.name} is already requested.`);
        }
        addMarkers(helpers); // Refresh markers
        updateHelperList(helpers); // Refresh helper list
      }
    }

    // Search for an area using OpenStreetMap Nominatim API
    async function searchArea() {
      const searchQuery = document.getElementById('search-input').value;
      if (!searchQuery) {
        alert('Please enter an area to search.');
        return;
      }

      // Fetch location data from Nominatim API
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&bounded=1&viewbox=${mapBounds[0][1]},${mapBounds[1][0]},${mapBounds[1][1]},${mapBounds[0][0]}`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.length === 0) {
        alert('No location found. Please try again.');
        return;
      }

      // Center the map on the searched location
      const location = data[0];
      const lat = parseFloat(location.lat);
      const lon = parseFloat(location.lon);
      map.setView([lat, lon], 14);

      // Filter helpers within a certain range (e.g., 2km)
      const filteredHelpers = helpers.filter(helper => {
        const distance = Math.sqrt(
          Math.pow(helper.lat - lat, 2) + Math.pow(helper.lng - lon, 2)
        );
        return distance < 0.02; // Adjust the threshold as needed
      });

      // Update map markers and helper list
      addMarkers(filteredHelpers);
      updateHelperList(filteredHelpers);
    }
  </script>
</body>
</html>
